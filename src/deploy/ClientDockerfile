FROM ubuntu:latest

# Set non-interactive mode to avoid user prompts
ENV DEBIAN_FRONTEND=noninteractive

# Install necessary packages
RUN apt-get -y update && \
    apt-get -y upgrade && \
    apt-get -y install dnsutils git vim python3 python3-aiohttp libssl-dev libz-dev luarocks iputils-ping lynx build-essential gcc bash curl cargo && \
    luarocks install luasocket

# Clone and build wrk2
RUN git clone https://github.com/yizhengx/wrk2.git && \
    cd wrk2 && \
    make && \
    cd /

# Clone and build wrk (mucache branch)
RUN git clone https://github.com/yizhengx/wrk.git && \
    cd wrk && \
    git checkout mucache && \
    make && \
    cd /

# RUN git clone https://github.com/yizhengx/mucache.git && \
#     cd mucache && \
#     git checkout boutique-porting-wip && \
#     cd proxy && \
#     cargo build --release && \
#     cd /

COPY ./proxy /mucache/proxy

RUN cd /mucache/proxy && \
    cargo build --release && \
    cd /

# Set default command to keep container running
CMD ["sleep", "365d"]
